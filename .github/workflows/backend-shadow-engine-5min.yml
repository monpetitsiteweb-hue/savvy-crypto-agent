name: Backend Shadow Engine (5min)

on:
  schedule:
    # Every 5 minutes
    - cron: '*/5 * * * *'
  workflow_dispatch:
    inputs:
      symbols:
        description: 'Comma-separated symbols (default: BTC,ETH,SOL,AVAX,XRP,ADA)'
        required: false
        default: 'BTC,ETH,SOL,AVAX,XRP,ADA'

jobs:
  run-shadow-engine:
    runs-on: ubuntu-latest
    steps:
      - name: Invoke Backend Shadow Engine
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "üåë SHADOW ENGINE: Triggering scheduled shadow evaluation..."
          echo "Mode: SHADOW (no trades will be inserted)"
          echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          
          # Default symbol list
          SYMBOLS="${{ github.event.inputs.symbols || 'BTC,ETH,SOL,AVAX,XRP,ADA' }}"
          
          # Convert comma-separated to JSON array
          SYMBOLS_JSON=$(echo "$SYMBOLS" | tr ',' '\n' | jq -R . | jq -s .)
          
          echo "üìä Symbols JSON: $SYMBOLS_JSON"
          
          # Query trading_strategies directly to get active user_id
          echo "üìã Querying trading_strategies for active user..."
          USER_ID_RAW=$(curl -s -X GET \
            "${SUPABASE_URL}/rest/v1/trading_strategies?is_active=eq.true&select=user_id&limit=1" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}")
          
          echo "üìã Raw response: $USER_ID_RAW"
          
          # Extract user_id and strip any extra quotes
          USER_ID=$(echo "$USER_ID_RAW" | jq -r '.[0].user_id // empty')
          
          if [ -z "$USER_ID" ] || [ "$USER_ID" = "null" ]; then
            echo "‚ùå No active strategy found - skipping shadow run"
            exit 0
          fi
          
          echo "üë§ Using userId: $USER_ID"
          echo "üìä Symbols: $SYMBOLS"
          
          # Build JSON body explicitly to avoid escaping issues
          JSON_BODY=$(jq -n \
            --arg userId "$USER_ID" \
            --argjson symbols "$SYMBOLS_JSON" \
            '{userId: $userId, symbols: $symbols}')
          
          echo "üì¶ Request body: $JSON_BODY"
          
          # Invoke backend-shadow-engine with SHADOW mode
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "${SUPABASE_URL}/functions/v1/backend-shadow-engine" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Content-Type: application/json" \
            -d "$JSON_BODY")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "üì° Response code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "‚úÖ Shadow engine completed successfully"
            echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY"
            
            # Extract summary stats
            WOULD_BUY=$(echo "$BODY" | jq '.summary.wouldBuy // 0')
            WOULD_SELL=$(echo "$BODY" | jq '.summary.wouldSell // 0')
            WOULD_HOLD=$(echo "$BODY" | jq '.summary.wouldHold // 0')
            TOTAL=$(echo "$BODY" | jq '.summary.total // 0')
            ELAPSED=$(echo "$BODY" | jq '.elapsed_ms // 0')
            
            echo ""
            echo "üìä SHADOW RUN SUMMARY"
            echo "  Symbols evaluated: $TOTAL"
            echo "  Would BUY: $WOULD_BUY"
            echo "  Would SELL: $WOULD_SELL"  
            echo "  Would HOLD: $WOULD_HOLD"
            echo "  Elapsed: ${ELAPSED}ms"
            echo ""
            echo "‚ö†Ô∏è  SHADOW MODE: No trades were inserted to mock_trades"
          else
            echo "‚ùå Shadow engine failed with code $HTTP_CODE"
            echo "$BODY"
            exit 1
          fi
