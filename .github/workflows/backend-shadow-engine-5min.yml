name: Backend Shadow Engine (5min)

on:
  schedule:
    # Every 5 minutes
    - cron: '*/5 * * * *'
  workflow_dispatch:
    inputs:
      symbols:
        description: 'Comma-separated symbols (default: BTC,ETH,SOL,AVAX,XRP,ADA)'
        required: false
        default: 'BTC,ETH,SOL,AVAX,XRP,ADA'

jobs:
  run-shadow-engine:
    runs-on: ubuntu-latest
    steps:
      - name: Invoke Backend Shadow Engine
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "ğŸŒ‘ SHADOW ENGINE: Triggering scheduled shadow evaluation..."
          echo "Mode: SHADOW (no trades will be inserted)"
          echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          
          # Default symbol list
          SYMBOLS="${{ github.event.inputs.symbols || 'BTC,ETH,SOL,AVAX,XRP,ADA' }}"
          
          # Convert comma-separated to JSON array
          SYMBOLS_JSON=$(echo "$SYMBOLS" | tr ',' '\n' | jq -R . | jq -s .)
          
          echo "ğŸ“Š Symbols JSON: $SYMBOLS_JSON"
          
          # Query trading_strategies to get ALL active user_ids
          echo "ğŸ“‹ Querying trading_strategies for active users..."
          USER_IDS_RAW=$(curl -s -X GET \
            "${SUPABASE_URL}/rest/v1/trading_strategies?is_active=eq.true&select=user_id" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}")
          
          echo "ğŸ“‹ Raw response: $USER_IDS_RAW"
          
          # Extract unique user_ids
          USER_IDS=$(echo "$USER_IDS_RAW" | jq -r '[.[].user_id] | unique | .[]')
          
          if [ -z "$USER_IDS" ]; then
            echo "âŒ No active strategies found - skipping shadow run"
            exit 0
          fi
          
          USER_COUNT=$(echo "$USER_IDS" | wc -l)
          echo "ğŸ‘¥ Found $USER_COUNT active users"
          
          # Process each user
          for USER_ID in $USER_IDS; do
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ‘¤ Processing user: $USER_ID"
            echo "ğŸ“Š Symbols: $SYMBOLS"
            
            # Build JSON body explicitly to avoid escaping issues
            JSON_BODY=$(jq -n \
              --arg userId "$USER_ID" \
              --argjson symbols "$SYMBOLS_JSON" \
              '{userId: $userId, symbols: $symbols}')
            
            echo "ğŸ“¦ Request body: $JSON_BODY"
            
            # Invoke backend-shadow-engine with SHADOW mode
            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
              "${SUPABASE_URL}/functions/v1/backend-shadow-engine" \
              -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
              -H "Content-Type: application/json" \
              -d "$JSON_BODY")
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            echo "ğŸ“¡ Response code: $HTTP_CODE"
            
            if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
              echo "âœ… Shadow engine completed for user $USER_ID"
              echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY"
              
              # Extract summary stats
              WOULD_BUY=$(echo "$BODY" | jq '.summary.wouldBuy // 0')
              WOULD_SELL=$(echo "$BODY" | jq '.summary.wouldSell // 0')
              WOULD_HOLD=$(echo "$BODY" | jq '.summary.wouldHold // 0')
              TOTAL=$(echo "$BODY" | jq '.summary.total // 0')
              ELAPSED=$(echo "$BODY" | jq '.elapsed_ms // 0')
              
              echo ""
              echo "ğŸ“Š USER SUMMARY: $USER_ID"
              echo "  Symbols evaluated: $TOTAL"
              echo "  Would BUY: $WOULD_BUY"
              echo "  Would SELL: $WOULD_SELL"  
              echo "  Would HOLD: $WOULD_HOLD"
              echo "  Elapsed: ${ELAPSED}ms"
            else
              echo "âŒ Shadow engine failed for user $USER_ID with code $HTTP_CODE"
              echo "$BODY"
              # Continue to next user instead of failing entirely
            fi
          done
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… All users processed"
          echo "âš ï¸  SHADOW MODE: No trades were inserted to mock_trades"
