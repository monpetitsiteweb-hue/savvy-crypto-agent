<!DOCTYPE html>
<html>
<head>
    <title>Step 4 Runtime Evidence Collection</title>
    <style>
        body { font-family: monospace; margin: 20px; background: #f0f0f0; }
        .container { max-width: 1200px; background: white; padding: 20px; margin: 0 auto; }
        .test-result { background: #f5f5f5; padding: 15px; margin: 10px 0; border-left: 4px solid #007acc; }
        .error { border-left-color: #cc0000; background: #fff5f5; }
        .success { border-left-color: #00cc00; background: #f5fff5; }
        button { padding: 10px 20px; margin: 5px; background: #007acc; color: white; border: none; cursor: pointer; }
        button:hover { background: #005c99; }
        .log { background: #000; color: #0f0; padding: 15px; margin: 10px 0; font-size: 12px; overflow-x: auto; }
        .evidence-section { border: 2px solid #007acc; margin: 20px 0; padding: 15px; }
        h2 { color: #007acc; }
        pre { background: #333; color: #fff; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Step 4 Runtime Evidence Collection</h1>
        <p><strong>Goal:</strong> Collect logs and evidence for all 4 coordinator paths</p>
        
        <div class="evidence-section">
            <h2>Test Controls</h2>
            <button onclick="testUDOff()">üéØ Test UD=OFF (Direct)</button>
            <button onclick="testUDOnExecute()">üéØ Test UD=ON (Execute)</button>
            <button onclick="testUDOnHold()">üéØ Test UD=ON (Hold/Cooldown)</button>
            <button onclick="testConcurrent()">üéØ Test Concurrent (Defer)</button>
            <button onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
        </div>

        <div class="evidence-section">
            <h2>Expected Log Patterns</h2>
            <ul>
                <li><strong>UD=OFF:</strong> "üéØ UD_MODE=OFF ‚Üí DIRECT EXECUTION: action=BUY symbol=BTC lock=NONE"</li>
                <li><strong>UD=ON HOLD:</strong> "üéØ UD_MODE=ON ‚Üí HOLD: reason=blocked_by_cooldown symbol=ETH"</li>
                <li><strong>UD=ON DEFER:</strong> "üéØ UD_MODE=ON ‚Üí DEFER: reason=atomic_section_busy_defer symbol=XRP retry=350ms"</li>
                <li><strong>UD=ON EXECUTE:</strong> "üéØ UD_MODE=ON ‚Üí EXECUTE: action=SELL symbol=BTC lock=OK"</li>
            </ul>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        const API_ENDPOINT = 'https://fuieplftlcxdfkxyqzlt.supabase.co/functions/v1/trading-decision-coordinator';
        const AUTH_KEY = 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJmZiI6ImZ1aWVwbGZ0bGN4ZGZreHlxemx0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIyMjg3OTQsImV4cCI6MjA2NzgwNDc5NH0.t1DwSViIf_ya-7fUTqM5d56CPINq0JdAYt-YFJs8fa8';
        
        // Strategy with UD=ON (current active strategy)
        const BASE_INTENT = {
            userId: '25a0c221-1f0e-431d-8d79-db9fb4db9cb3',
            strategyId: '5f0664fd-98cb-4ec2-8c2b-95cb1a28b80e',
            source: 'manual',
            confidence: 0.8
        };

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong><br>${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('results').innerHTML = '';
        }

        async function callCoordinator(intent, testName) {
            try {
                log(`üéØ ${testName} - Sending intent...`, 'info');
                
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Authorization': AUTH_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ intent })
                });

                const result = await response.json();
                
                log(`‚úÖ ${testName} Response:<br><pre>${JSON.stringify(result, null, 2)}</pre>`, 
                    result.decision?.action === 'HOLD' ? 'error' : 'success');
                
                return result;
            } catch (error) {
                log(`‚ùå ${testName} Error: ${error.message}`, 'error');
                return null;
            }
        }

        // Test 1: UD=OFF Direct Execution (temporarily disable UD for this test)
        async function testUDOff() {
            const intent = {
                ...BASE_INTENT,
                symbol: 'BTC',
                side: 'BUY',
                reason: 'step4_ud_off_test',
                ts: Date.now().toString(),
                // Note: In real test, we'd need to disable UD in strategy config
                // For now, this will show UD=ON behavior
            };
            
            await callCoordinator(intent, 'UD=OFF Direct Execution Test');
        }

        // Test 2: UD=ON Execute (clean symbol, should execute)
        async function testUDOnExecute() {
            const intent = {
                ...BASE_INTENT,
                symbol: 'ETH',
                side: 'BUY',
                reason: 'step4_clean_execute_test',
                ts: Date.now().toString()
            };
            
            await callCoordinator(intent, 'UD=ON Execute Test');
        }

        // Test 3: UD=ON Hold (create cooldown conflict)
        async function testUDOnHold() {
            log('üîÑ Setting up cooldown conflict test...', 'info');
            
            // First, execute a BUY
            const buyIntent = {
                ...BASE_INTENT,
                symbol: 'XRP',
                side: 'BUY',
                source: 'automated',
                reason: 'setup_for_cooldown',
                ts: Date.now().toString()
            };
            
            await callCoordinator(buyIntent, 'Setup Buy for Cooldown');
            
            // Then immediately try to SELL (should trigger cooldown HOLD)
            setTimeout(async () => {
                const sellIntent = {
                    ...BASE_INTENT,
                    symbol: 'XRP',
                    side: 'SELL',
                    source: 'automated',
                    reason: 'trigger_cooldown_hold',
                    ts: (Date.now() + 1000).toString()
                };
                
                await callCoordinator(sellIntent, 'UD=ON Hold (Cooldown) Test');
            }, 1000);
        }

        // Test 4: Concurrent requests to trigger DEFER
        async function testConcurrent() {
            log('üîÑ Sending 8 concurrent requests to trigger DEFER...', 'info');
            
            const promises = [];
            for (let i = 0; i < 8; i++) {
                const intent = {
                    ...BASE_INTENT,
                    symbol: 'SOL',
                    side: 'BUY',
                    source: 'automated',
                    reason: `concurrent_${i}`,
                    ts: (Date.now() + i * 5).toString() // Slightly stagger timestamps
                };
                
                promises.push(callCoordinator(intent, `Concurrent Request ${i + 1}`));
            }
            
            // Execute all requests simultaneously
            await Promise.all(promises);
        }

        // Auto-start evidence collection
        window.onload = function() {
            log('Step 4 Runtime Evidence Collection Started', 'success');
            log('Strategy ID: 5f0664fd-98cb-4ec2-8c2b-95cb1a28b80e (UD=ON)', 'info');
            log('Click test buttons above to collect evidence for each coordinator path', 'info');
        }
    </script>
</body>
</html>